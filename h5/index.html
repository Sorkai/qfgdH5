<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¸…é£å·¥å¤§Â·æ‰£å¥½äººç”Ÿç¬¬ä¸€ç²’æ‰£å­</title>
    <script src="/js/tailwindcss.js"></script>
    <link href="/css/animate.min.css" rel="stylesheet">
    <style>
        @import url('/css/NotoSerifSC.css');

        body {
            font-family: 'Noto Serif SC', serif;
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- çº¹ç†ä¸åŸºç¡€æ ·å¼ --- */
        .shirt-texture {
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23374151' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.02);
        }

        .stitch-line {
            background-image: linear-gradient(to bottom, #9ca3af 50%, transparent 50%);
            background-size: 2px 12px;
            width: 2px;
        }

        .button-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), inset 0 -2px 4px rgba(0, 0, 0, 0.05);
        }

        .hole-inner {
            background: #374151;
            box-shadow: inset 1px 1px 4px rgba(0, 0, 0, 0.6);
        }

        /* --- åŠ¨ç”» --- */
        @keyframes float-hint {

            0%,
            100% {
                transform: translate3d(0, 0, 0);
            }

            50% {
                transform: translate3d(0, -12px, 0);
            }
        }

        .animate-float-centered {
            animation: float-hint 2s ease-in-out infinite;
            will-change: transform;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0px rgba(13, 148, 136, 0.6);
            }

            70% {
                box-shadow: 0 0 0 12px rgba(13, 148, 136, 0);
            }
        }

        .pulse-ring {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pan-horizontal {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 100% 50%;
            }
        }

        .bg-pan-effect {
            background-size: auto 100% !important;
            animation: pan-horizontal 40s linear infinite alternate;
            will-change: background-position;
        }

        @keyframes slow-zoom {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.15);
            }
        }

        .bg-zoom-effect {
            animation: slow-zoom 25s linear infinite alternate;
            will-change: transform;
        }

        .loader-spin {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d9488;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* å›¾ç‰‡ç»“æœé¡µä¼˜åŒ– */
        #img-container img {
            max-height: 75vh;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>

<body class="bg-gray-100 h-screen w-screen overflow-hidden relative text-gray-800">

    <!-- Loading -->
    <div id="preloader"
        class="fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader-spin mb-4"></div>
        <p class="text-teal-800 text-sm font-bold tracking-widest">æ¸…é£å·¥å¤§ Â· æ­£åœ¨åŠ è½½</p>
    </div>

    <!-- èƒŒæ™¯å±‚ -->
    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center bg-no-repeat transition-all duration-1000"
        style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');">
        <div class="absolute inset-0 bg-white/40 transition-colors duration-1000 backdrop-blur-[1px]" id="bg-overlay">
        </div>
    </div>

    <!-- ä¸»äº¤äº’åŒºåŸŸ -->
    <div id="app"
        class="relative z-10 w-full h-full flex flex-col items-center justify-between py-safe-top pb-safe-bottom">

        <header class="text-center mt-8 md:mt-12 opacity-0 animate__animated animate__fadeInDown px-4 relative z-30"
            id="header-area">
            <div
                class="inline-block px-3 py-1 bg-white/60 backdrop-blur-sm rounded-full mb-2 border border-white/50 shadow-sm">
                <h2 class="text-teal-900 tracking-[0.2em] text-xs font-bold">æ¸…é£å·¥å¤§ Â· é’å¹´åˆ›å»‰</h2>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 drop-shadow-lg tracking-wide" id="main-title">
                æ‰£å¥½ç¬¬ä¸€ç²’æ‰£å­</h1>
            <p class="text-xs md:text-sm text-gray-800 mt-2 font-medium drop-shadow-md opacity-90" id="sub-title">
                å‘ä¸Šæ‹–åŠ¨æ‰£å­ï¼Œå¼€å¯å»‰æ´äººç”Ÿ</p>
        </header>

        <div class="relative w-full max-w-md flex-1 flex flex-col justify-center my-4 min-h-[400px]">
            <div
                class="absolute top-10 bottom-10 left-4 right-4 md:left-10 md:right-10 flex shadow-2xl rounded-3xl overflow-hidden transform rotate-1">
                <div class="w-1/2 bg-white shirt-texture border-r border-gray-200 relative">
                    <div class="absolute right-3 top-0 bottom-0 w-px stitch-line opacity-40"></div>
                </div>
                <div class="w-1/2 bg-white shirt-texture border-l border-gray-200 relative">
                    <div class="absolute left-3 top-0 bottom-0 w-px stitch-line opacity-40"></div>
                </div>
            </div>

            <div class="relative z-20 w-full h-full flex flex-col items-center justify-center">
                <div class="relative mb-32 md:mb-40">
                    <div id="button-hole"
                        class="w-16 h-4 bg-gray-200 rounded-full flex items-center justify-center border border-gray-300 transition-transform duration-200 shadow-inner">
                        <div class="w-12 h-1 hole-inner rounded-full"></div>
                    </div>
                    <div id="hole-glow"
                        class="absolute -inset-2 rounded-full border-2 border-teal-500 opacity-0 transition-opacity duration-300 pointer-events-none">
                    </div>
                </div>

                <div id="button-drag"
                    class="w-14 h-14 rounded-full bg-white border border-gray-100 button-shadow flex items-center justify-center cursor-grab animate-float-centered touch-none"
                    style="transform: translate3d(0, 0, 0);">
                    <div
                        class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center relative pointer-events-none">
                        <div
                            class="absolute w-full h-full rounded-full border border-gray-100 opacity-50 transform scale-75">
                        </div>
                        <div class="w-3 h-3 grid grid-cols-2 gap-0.5 transform rotate-45">
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                        </div>
                        <div class="absolute w-2.5 h-0.5 bg-teal-700/40 transform rotate-45"></div>
                        <div class="absolute w-2.5 h-0.5 bg-teal-700/40 transform -rotate-45"></div>
                    </div>

                    <div id="finger-hint"
                        class="absolute -bottom-20 flex flex-col items-center opacity-80 pointer-events-none animate-bounce">
                        <span class="text-2xl mb-1 filter drop-shadow-md">ğŸ‘†</span>
                        <span
                            class="text-xs text-gray-600 font-bold bg-white/80 px-3 py-1 rounded-full shadow-sm whitespace-nowrap">å‘ä¸Šæ‰£å¥½</span>
                    </div>
                </div>

                <div id="success-msg"
                    class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-500 z-50">
                    <div class="bg-teal-900/90 text-white px-8 py-5 rounded-xl shadow-2xl backdrop-blur-md text-center transform scale-90 transition-all duration-500 border border-teal-500/30"
                        id="success-box">
                        <h3 class="text-2xl font-bold mb-2 text-teal-50 tracking-wider" id="msg-title">å­¦æœ¯è¯šä¿¡</h3>
                        <div class="w-8 h-1 bg-teal-500 mx-auto mb-3 rounded-full"></div>
                        <p class="text-sm opacity-90 leading-relaxed font-light" id="msg-desc">æ±‚çœŸåŠ¡å®<br>ä¸æŠ„è¢­ï¼Œä¸ä½œä¼ª</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨è¿›åº¦ + å¤‡æ¡ˆä¿¡æ¯ -->
        <div class="mb-1 flex flex-col items-center z-20 w-full">
            <!-- è¿›åº¦ç‚¹ -->
            <div class="flex space-x-3 mb-4" id="progress-dots">
                <div
                    class="w-2.5 h-2.5 rounded-full bg-teal-600 transition-all duration-300 transform scale-125 shadow-sm">
                </div>
                <div
                    class="w-2.5 h-2.5 rounded-full bg-white/50 border border-gray-300 transition-all duration-300 shadow-sm">
                </div>
                <div
                    class="w-2.5 h-2.5 rounded-full bg-white/50 border border-gray-300 transition-all duration-300 shadow-sm">
                </div>
            </div>

            <!-- å¤‡æ¡ˆä¿¡æ¯ -->
            <footer
                class="text-[10px] text-gray-500/80 text-center leading-relaxed tracking-wide select-text pointer-events-auto bg-white/60 backdrop-blur-sm w-full py-1 border-t border-gray-100/50">
                <div class="mb-1"><a href="https://www.sorkai.com/" target="_blank"
                        class="hover:text-teal-700 transition-colors">ç‹é”´ 20210915</a></div>
                <div class="flex justify-center items-center flex-wrap gap-x-4 gap-y-1 px-4">
                    <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank"
                        class="hover:text-teal-700 transition-colors">æ´¥ICPå¤‡2021000853å·-5</a>
                    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12011402001230" rel="noopener"
                        target="_blank" class="flex items-center hover:text-teal-700 transition-colors">
                        <img src="https://jsd.kai233.top/web/img/batb.png" class="w-3 h-3 mr-1 opacity-80" alt="å…¬ç½‘å®‰å¤‡å›¾æ ‡">
                        æ´¥å…¬ç½‘å®‰å¤‡12011402001230å·
                    </a>
                </div>
            </footer>
        </div>

    </div>

    <!-- 3. æœ€ç»ˆç”Ÿæˆé¡µ -->
    <div id="final-screen" class="fixed inset-0 z-50 bg-gray-900/95 hidden flex-col items-center justify-center p-4">

        <!-- A. ç¼–è¾‘é˜¶æ®µ -->
        <div id="edit-stage" class="flex flex-col items-center w-full max-w-sm animate__animated animate__zoomIn">

            <div class="relative w-full mx-auto flex flex-col items-center pt-2">

                <img src="https://img.kai233.top/2025/11/25/692492bdb9fd0.png!webp" alt="æ ¡å¾½"
                    class="absolute top-0 left-1/2 transform -translate-x-1/2 w-24 h-24 object-contain drop-shadow-xl bg-white rounded-full p-1 border-[3px] border-white z-20">

                <div
                    class="relative w-full bg-white shadow-2xl rounded-xl border-8 border-teal-50 text-center px-6 mt-12 pt-14 pb-8 flex flex-col items-center z-10 overflow-hidden">

                    <div class="absolute inset-0 opacity-10"
                        style="background-image: radial-gradient(#999 1px, transparent 1px); background-size: 16px 16px; pointer-events: none;">
                    </div>

                    <div class="relative z-10 w-full flex flex-col items-center">

                        <h2 class="text-lg text-teal-800 font-bold tracking-[0.2em] uppercase mb-3 leading-none">æ¸…é£å·¥å¤§ Â·
                            é’å¹´åˆ›å»‰</h2>
                        <div
                            class="h-px w-3/4 bg-gradient-to-r from-transparent via-teal-300 to-transparent mx-auto mb-3">
                        </div>

                        <h1 class="text-4xl font-serif font-bold text-gray-900 mb-4 leading-tight">å»‰æ´æ‰¿è¯ºä¹¦</h1>

                        <p class="text-gray-600 text-base leading-relaxed mb-5 font-serif px-2">
                            æˆ‘åœ¨<span class="font-bold text-teal-700 mx-1">é•¿æ˜¥å·¥ä¸šå¤§å­¦</span>çš„è§è¯ä¸‹ï¼Œ<br>
                            éƒ‘é‡æ‰£å¥½äº†äººç”Ÿçš„ä¸‰ç²’æ‰£å­ã€‚
                        </p>

                        <div class="bg-teal-50 py-3 px-4 rounded-lg border border-teal-100 mb-5 w-full">
                            <span class="block text-teal-900 font-bold text-xl tracking-widest leading-none">è¯šä¿¡ Â· è‡ªå¾‹ Â·
                                æ‹…å½“</span>
                        </div>

                        <!-- åå­—è¾“å…¥åŒº -->
                        <div class="w-full mb-5">
                            <div class="border-b-2 border-dashed border-teal-300 pb-1 w-full transition-colors cursor-text group"
                                onclick="document.getElementById('final-username').focus()">
                                <p class="text-xs text-teal-500 mb-1 opacity-60 leading-none">ç‚¹å‡»ä¸‹æ–¹è¾“å…¥å§“å</p>
                                <input id="final-username" type="text"
                                    class="text-2xl font-bold text-gray-800 w-full text-center outline-none bg-transparent placeholder-gray-300 leading-normal"
                                    placeholder="ç‚¹å‡»ç­¾ç½²å§“å" />
                            </div>
                        </div>

                        <!-- ç¼–å· -->
                        <div class="transform -rotate-3 mb-4 select-none">
                            <div
                                class="border-[3px] border-red-700 text-red-700 px-6 py-3 rounded-md text-sm font-bold bg-white/90 backdrop-blur-sm shadow-md flex flex-col items-center justify-center">
                                <div class="text-xs font-normal opacity-80 leading-none mb-1">æˆ‘æ˜¯ç¬¬</div>
                                <div class="text-3xl font-mono leading-none font-black tracking-tighter text-red-800"
                                    id="player-count">...</div>
                                <div class="text-xs font-normal opacity-80 leading-none mt-1">ä½æ‰¿è¯ºäºº</div>
                            </div>
                        </div>

                        <div class="text-xs text-gray-400 text-right font-serif leading-tight w-full mt-1">
                            <p>é©¬å…‹æ€ä¸»ä¹‰å­¦é™¢</p>
                            <p class="mt-1">å½¢åŠ¿ä¸æ”¿ç­–æ•™ç ”å®¤</p>
                            <p class="font-mono mt-1">2025.11</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="generatePosterCanvas()"
                class="mt-8 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 flex items-center space-x-2">
                <span>âœ¨ ç”Ÿæˆä¸“å±æµ·æŠ¥</span>
            </button>
            <p class="text-white/40 text-xs mt-3">è¯·å…ˆç‚¹å‡»ä¸Šæ–¹è¾“å…¥å§“åï¼Œå†ç”Ÿæˆ</p>

        </div>

        <!-- B. ç»“æœé˜¶æ®µ -->
        <div id="poster-result"
            class="hidden flex-col items-center w-full h-full justify-center animate__animated animate__fadeIn">
            <div class="flex-1 flex flex-col justify-center items-center w-full max-w-sm" style="max-height: 80vh;">
                <div id="img-container" class="relative w-full h-full flex items-center justify-center">
                    <!-- å›¾ç‰‡å°†è¢« JS æ’å…¥åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <div class="mt-6 text-center z-50">
                <p
                    class="text-white text-sm font-bold bg-black/40 px-6 py-2 rounded-full backdrop-blur-md mb-4 border border-white/10 animate-pulse">
                    é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ Â· ä¿å­˜åˆ†äº«
                </p>
                <button onclick="location.reload()"
                    class="text-white/60 text-sm px-6 py-2 border border-white/20 rounded-full hover:bg-white/10 hover:text-white transition-colors">
                    â†º å†ç©ä¸€æ¬¡
                </button>
            </div>
        </div>

        <div id="generating-toast"
            class="hidden absolute inset-0 z-[60] bg-black/80 flex-col items-center justify-center text-white">
            <div class="loader-spin mb-4 border-t-white"></div>
            <p>æ­£åœ¨ç»˜åˆ¶æµ·æŠ¥...</p>
        </div>

    </div>

    <script>
        // èµ„æºé…ç½®
        const stages = [
            {
                title: "ç¬¬ä¸€ç²’æ‰£å­ï¼šè¯šä¿¡",
                subtitle: "åšäººå¦‚è¡£ï¼Œè¯šä¿¡ä¸ºæœ¬",
                desc: "åœ¨å·¥å¤§å›¾ä¹¦é¦†è®¸ä¸‹è¯ºè¨€ï¼š\nå­¦æœ¯ä¸é€ å‡ï¼Œæ±‚å®åˆ›æ–°ã€‚",
                bg: "https://img.kai233.top/2025/11/25/6924897e240f3.jpg!webp",
                overlayOpacity: "bg-white/50",
                isPanorama: false
            },
            {
                title: "ç¬¬äºŒç²’æ‰£å­ï¼šè‡ªå¾‹",
                subtitle: "ä¿®èº«ç«‹å¾·ï¼Œé˜²å¾®æœæ¸",
                desc: "è¡Œèµ°åœ¨æ ¡å›­çš„é“¶æå¤§é“ï¼Œ\nè„šè¸å®åœ°ï¼Œå®ˆä½æœ¬å¿ƒã€‚",
                bg: "https://img.kai233.top/2025/11/25/69248dd4c151b.png!webp",
                overlayOpacity: "bg-white/40",
                isPanorama: false
            },
            {
                title: "ç¬¬ä¸‰ç²’æ‰£å­ï¼šæ‹…å½“",
                subtitle: "æ¸…é£å·¥å¤§ï¼Œé’å¹´æœ‰ä¸º",
                desc: "ä¸ä»…ç‹¬å–„å…¶èº«ï¼Œ\næ›´è¦å…¼æµå¤©ä¸‹ï¼Œä¼ é€’æ­£èƒ½é‡ã€‚",
                bg: "https://img.kai233.top/2025/11/25/69248dd4789af.png!webp",
                overlayOpacity: "bg-white/40",
                isPanorama: true // æœ€åä¸€å…³ä¸ºå…¨æ™¯
            }
        ];

        let currentStage = 0;
        let isDragging = false;
        let startY = 0;
        let currentTranslateY = 0;
        let participantCount = "...";

        // é¢„åŠ è½½æ ¡å¾½
        const badgeImg = new Image();
        badgeImg.crossOrigin = "anonymous";
        badgeImg.src = "https://img.kai233.top/2025/11/25/692492bdb9fd0.png!webp";

        const els = {
            btnDrag: document.getElementById('button-drag'),
            btnHole: document.getElementById('button-hole'),
            bgLayer: document.getElementById('bg-layer'),
            bgOverlay: document.getElementById('bg-overlay'),
            mainTitle: document.getElementById('main-title'),
            subTitle: document.getElementById('sub-title'),
            successMsg: document.getElementById('success-msg'),
            successBox: document.getElementById('success-box'),
            msgTitle: document.getElementById('msg-title'),
            msgDesc: document.getElementById('msg-desc'),
            holeGlow: document.getElementById('hole-glow'),
            dots: document.getElementById('progress-dots').children,
            fingerHint: document.getElementById('finger-hint'),
            preloader: document.getElementById('preloader')
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function unlockAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            document.removeEventListener('touchstart', unlockAudio);
            document.removeEventListener('click', unlockAudio);
        }
        document.addEventListener('touchstart', unlockAudio);
        document.addEventListener('click', unlockAudio);

        function playSnapSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function triggerHaptic() {
            // å°è¯•å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨ API
            const vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;

            if (vibrate) {
                // ä½¿ç”¨ call ç»‘å®šä¸Šä¸‹æ–‡ï¼Œå¹¶å°è¯•æ›´é•¿çš„éœ‡åŠ¨æ—¶é—´ (200ms) ä»¥ç¡®ä¿æ„ŸçŸ¥
                // éƒ¨åˆ† Android æµè§ˆå™¨å¯¹çŸ­éœ‡åŠ¨å¯èƒ½ä¼šå¿½ç•¥
                try {
                    vibrate.call(navigator, [200]);
                } catch (e) {
                    // å¿½ç•¥ä¸æ”¯æŒçš„æƒ…å†µ
                }
            }
        }

        const getClientY = (e) => e.touches ? e.touches[0].clientY : e.clientY;

        const updatePosition = () => {
            els.btnDrag.style.transform = `translate3d(0, ${currentTranslateY}px, 0)`;
        };

        const startDrag = (e) => {
            if (e.touches && e.touches.length > 1) return;
            e.preventDefault();
            if (currentStage >= stages.length) return;

            isDragging = true;
            startY = getClientY(e);

            els.btnDrag.classList.remove('animate-float-centered');
            els.fingerHint.style.opacity = '0';
            els.holeGlow.style.opacity = '1';
            els.holeGlow.classList.add('pulse-ring');
            els.btnDrag.style.transition = 'none';
        };

        const moveDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();

            const y = getClientY(e);
            const deltaY = y - startY;

            if (deltaY < -350) currentTranslateY = -350;
            else if (deltaY > 100) currentTranslateY = 100;
            else currentTranslateY = deltaY;

            requestAnimationFrame(updatePosition);

            const holeRect = els.btnHole.getBoundingClientRect();
            const btnRect = els.btnDrag.getBoundingClientRect();

            const isOverlapping = !(btnRect.bottom < holeRect.top + 10 || btnRect.top > holeRect.bottom - 10);

            if (isOverlapping) {
                els.btnHole.style.borderColor = "#0d9488";
                els.btnHole.style.transform = "scale(1.1)";
            } else {
                els.btnHole.style.borderColor = "#d1d5db";
                els.btnHole.style.transform = "scale(1)";
            }
        };

        const endDrag = (e) => {
            if (!isDragging) return;
            isDragging = false;

            const holeRect = els.btnHole.getBoundingClientRect();
            const btnRect = els.btnDrag.getBoundingClientRect();

            const holeCenterY = holeRect.top + holeRect.height / 2;
            const btnCenterY = btnRect.top + btnRect.height / 2;
            const distance = Math.abs(holeCenterY - btnCenterY);

            if (distance < 80) {
                snapButton();
            } else {
                resetButton();
            }

            els.holeGlow.style.opacity = '0';
            els.holeGlow.classList.remove('pulse-ring');
            els.btnHole.style.transform = "scale(1)";
            els.btnHole.style.borderColor = "#d1d5db";
        };

        const snapButton = () => {
            playSnapSound();
            triggerHaptic();

            els.btnDrag.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";

            const dragRect = els.btnDrag.getBoundingClientRect();
            const holeRect = els.btnHole.getBoundingClientRect();
            const holeTop = els.btnHole.offsetTop;
            const dragInitialTop = els.btnDrag.offsetTop;

            const targetTranslateY = (holeTop - dragInitialTop) + (els.btnHole.offsetHeight - els.btnDrag.offsetHeight) / 2;

            els.btnDrag.style.transform = `translate3d(0, ${targetTranslateY}px, 0) scale(0.9)`;
            els.btnDrag.style.boxShadow = "none";

            setTimeout(() => { showSuccess(); }, 350);
        };

        const resetButton = () => {
            els.btnDrag.style.transition = "transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55)";
            currentTranslateY = 0;
            els.btnDrag.style.transform = `translate3d(0, 0, 0)`;

            setTimeout(() => {
                els.btnDrag.classList.add('animate-float-centered');
                els.fingerHint.style.opacity = '1';
            }, 500);
        };

        const showSuccess = () => {
            const data = stages[currentStage];

            els.msgTitle.innerText = data.title.split('ï¼š')[1];
            els.msgDesc.innerText = data.desc;

            els.successMsg.classList.remove('pointer-events-none', 'opacity-0');
            els.successBox.classList.remove('scale-90');
            els.successBox.classList.add('scale-100');

            els.mainTitle.innerText = data.title;
            els.subTitle.innerText = data.subtitle;

            setTimeout(() => { nextStage(); }, 2200);
        };

        const nextStage = () => {
            els.successMsg.classList.add('opacity-0', 'pointer-events-none');
            els.successBox.classList.remove('scale-100');
            els.successBox.classList.add('scale-90');

            if (els.dots[currentStage]) {
                els.dots[currentStage].classList.add('bg-teal-600', 'border-transparent');
                els.dots[currentStage].classList.remove('bg-white/50', 'scale-125');
            }

            currentStage++;

            if (currentStage >= stages.length) {
                finishGame();
                return;
            }

            els.dots[currentStage].classList.remove('bg-white/50');
            els.dots[currentStage].classList.add('bg-teal-600', 'scale-125', 'border-transparent');

            els.bgLayer.style.opacity = 0;

            setTimeout(() => {
                const nextData = stages[currentStage];
                els.bgLayer.style.backgroundImage = `url('${nextData.bg}')`;
                els.bgOverlay.className = `absolute inset-0 transition-colors duration-1000 backdrop-blur-[1px] ${nextData.overlayOpacity}`;

                if (nextData.isPanorama) {
                    els.bgLayer.classList.remove('bg-cover', 'bg-center', 'bg-zoom-effect');
                    els.bgLayer.classList.add('bg-pan-effect');
                } else {
                    els.bgLayer.classList.remove('bg-pan-effect');
                    els.bgLayer.classList.add('bg-cover', 'bg-center', 'bg-zoom-effect');
                }
                els.bgLayer.style.opacity = 1;
            }, 500);

            els.btnDrag.style.transition = "transform 0.5s ease-in";
            els.btnDrag.style.transform = `translate3d(0, 300px, 0)`;

            setTimeout(() => {
                els.btnDrag.style.transition = "transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)";
                els.btnDrag.style.transform = `translate3d(0, 0, 0)`;
                els.btnDrag.style.boxShadow = "";
                currentTranslateY = 0;

                setTimeout(() => {
                    els.btnDrag.classList.add('animate-float-centered');
                    els.fingerHint.style.opacity = '1';
                }, 600);
            }, 600);
        };

        const finishGame = async () => {
            const finalScreen = document.getElementById('final-screen');
            finalScreen.classList.remove('hidden');
            finalScreen.classList.add('flex');

            await fetchParticipantCount();
        };

        // -----------------------------------------------------
        // æ ¸å¿ƒæ›´æ–°ï¼šä½¿ç”¨ Canvas API ç›´æ¥ç»˜å›¾ï¼Œä¸å†ä¾èµ– html2canvas
        // -----------------------------------------------------
        const generatePosterCanvas = () => {
            const nameInput = document.getElementById('final-username');
            const name = nameInput.value.trim() || "å·¥å¤§é’å¹´";
            const generatingToast = document.getElementById('generating-toast');

            generatingToast.classList.remove('hidden');
            generatingToast.classList.add('flex');

            // ä½¿ç”¨ setTimeout ç»™ UI ä¸€ç‚¹æ¸²æŸ“æ—¶é—´
            setTimeout(() => {
                drawCanvas(name, participantCount).then(dataUrl => {
                    generatingToast.classList.add('hidden');
                    document.getElementById('edit-stage').style.display = 'none';
                    document.getElementById('poster-result').classList.remove('hidden');
                    document.getElementById('poster-result').classList.add('flex');

                    const img = document.createElement('img');
                    img.src = dataUrl;
                    document.getElementById('img-container').innerHTML = ''; // æ¸…ç©ºæ—§å›¾
                    document.getElementById('img-container').appendChild(img);
                }).catch(e => {
                    console.error(e);
                    generatingToast.innerHTML = "ç”Ÿæˆå¤±è´¥";
                });
            }, 300);
        };

        // Canvas ç»˜åˆ¶æ ¸å¿ƒå‡½æ•°
        function drawCanvas(name, countNum) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // è®¾ç½®ç”»å¸ƒå°ºå¯¸ (2å€é«˜æ¸…)
                const width = 750;
                const height = 1334; // ç•¥å¾®è°ƒé«˜ä¿è¯å®¹çº³
                canvas.width = width;
                canvas.height = height;

                // 1. ç»˜åˆ¶ç™½è‰²å¡ç‰‡èƒŒæ™¯ (å¸¦åœ†è§’)
                // å®é™…å¡ç‰‡åŒºåŸŸï¼Œç•™å‡º padding
                const cardX = 40;
                const cardY = 160; // é¡¶éƒ¨ç•™ç»™æ ¡å¾½
                const cardW = width - 80;
                const cardH = height - 220;

                // ç»˜åˆ¶é˜´å½±
                ctx.shadowColor = "rgba(0, 0, 0, 0.2)";
                ctx.shadowBlur = 20;
                ctx.shadowOffsetY = 10;

                // ç»˜åˆ¶å¡ç‰‡æœ¬ä½“
                ctx.fillStyle = "#ffffff";
                roundRect(ctx, cardX, cardY, cardW, cardH, 30);
                ctx.fill();

                // æ¸…é™¤é˜´å½±ï¼Œå¼€å§‹ç»˜åˆ¶å†…å®¹
                ctx.shadowColor = "transparent";
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;

                // 2. ç»˜åˆ¶è¾¹æ¡† (border-teal-50 #f0fdfa)
                ctx.lineWidth = 16;
                ctx.strokeStyle = "#f0fdfa";
                ctx.stroke();

                // 3. ç»˜åˆ¶æ ¡å¾½ (åœ¨å¡ç‰‡ä¹‹ä¸Š)
                // è®¡ç®—ä¸­å¿ƒç‚¹
                const centerX = width / 2;
                const badgeSize = 200; // 100px * 2
                const badgeY = cardY - (badgeSize / 2); // éª‘åœ¨çº¿ä¸Š

                // ç»˜åˆ¶æ ¡å¾½ç™½è‰²åº•æ‰˜
                ctx.beginPath();
                ctx.arc(centerX, badgeY + badgeSize / 2, badgeSize / 2 + 8, 0, Math.PI * 2);
                ctx.fillStyle = "#ffffff";
                ctx.fill();

                // ç»˜åˆ¶æ ¡å¾½å›¾ç‰‡
                if (badgeImg.complete) {
                    ctx.drawImage(badgeImg, centerX - badgeSize / 2, badgeY, badgeSize, badgeSize);
                }

                // 4. ç»˜åˆ¶æ–‡å­—å†…å®¹
                ctx.textAlign = "center";
                ctx.textBaseline = "top"; // ç»Ÿä¸€åŸºçº¿

                // å°æ ‡é¢˜
                ctx.fillStyle = "#115e59"; // teal-800
                ctx.font = "bold 28px 'Noto Serif SC', serif";
                ctx.fillText("æ¸…é£å·¥å¤§ Â· é’å¹´åˆ›å»‰", centerX, cardY + 140);

                // åˆ†å‰²çº¿
                ctx.strokeStyle = "rgba(20, 184, 166, 0.3)"; // teal-300/30
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX - 180, cardY + 190);
                ctx.lineTo(centerX + 180, cardY + 190);
                ctx.stroke();

                // å¤§æ ‡é¢˜
                ctx.fillStyle = "#111827"; // gray-900
                ctx.font = "bold 64px 'Noto Serif SC', serif";
                ctx.fillText("å»‰æ´æ‰¿è¯ºä¹¦", centerX, cardY + 220);

                // æ­£æ–‡
                ctx.fillStyle = "#4b5563"; // gray-600
                ctx.font = "30px 'Noto Serif SC', serif";
                ctx.fillText("æˆ‘åœ¨ é•¿æ˜¥å·¥ä¸šå¤§å­¦ çš„è§è¯ä¸‹ï¼Œ", centerX, cardY + 330);
                ctx.fillText("éƒ‘é‡æ‰£å¥½äº†äººç”Ÿçš„ä¸‰ç²’æ‰£å­ã€‚", centerX, cardY + 380);

                // æ ‡è¯­å—
                const tagY = cardY + 460;
                ctx.fillStyle = "#f0fdfa"; // teal-50
                roundRect(ctx, centerX - 260, tagY, 520, 80, 16);
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#ccfbf1"; // teal-100
                ctx.stroke();

                ctx.fillStyle = "#134e4a"; // teal-900
                ctx.font = "bold 36px 'Noto Serif SC', serif";
                // æ–‡å­—å‚ç›´å±…ä¸­ä¿®æ­£
                ctx.textBaseline = "middle";
                ctx.fillText("è¯šä¿¡ Â· è‡ªå¾‹ Â· æ‹…å½“", centerX, tagY + 40);

                // åå­—
                ctx.textBaseline = "top";
                ctx.fillStyle = "#14b8a6"; // teal-500
                ctx.font = "24px sans-serif";
                ctx.fillText("ç‚¹å‡»ä¸‹æ–¹è¾“å…¥å§“å", centerX, tagY + 140);

                // åå­—ä¸»ä½“
                ctx.fillStyle = "#1f2937"; // gray-800
                ctx.font = "bold 56px sans-serif";
                ctx.fillText(name, centerX, tagY + 180);

                // 5. ç»˜åˆ¶å°ç«  (å¸¦æ—‹è½¬)
                const stampY = tagY + 300;
                const stampW = 320;
                const stampH = 240;

                ctx.save(); // ä¿å­˜çŠ¶æ€ä»¥ä¾¿æ—‹è½¬
                ctx.translate(centerX, stampY + stampH / 2); // ç§»åŠ¨åŸç‚¹åˆ°å°ç« ä¸­å¿ƒ
                ctx.rotate(-3 * Math.PI / 180); // æ—‹è½¬ -3 åº¦

                // å°ç« è¾¹æ¡†
                ctx.beginPath();
                // ç»˜åˆ¶ç›¸å¯¹åæ ‡çš„çŸ©å½¢
                roundRect(ctx, -stampW / 2, -stampH / 2, stampW, stampH, 12);
                ctx.fillStyle = "rgba(255, 255, 255, 0.95)";
                ctx.fill();
                ctx.lineWidth = 6;
                ctx.strokeStyle = "#b91c1c"; // red-700
                ctx.stroke();

                // å°ç« æ–‡å­—
                ctx.fillStyle = "rgba(185, 28, 28, 0.8)"; // text-red-700 opacity-80
                ctx.font = "28px sans-serif";
                ctx.fillText("æˆ‘æ˜¯ç¬¬", 0, -stampH / 2 + 40);

                // æ•°å­— - æ ¸å¿ƒä¿®æ­£ç‚¹ï¼šç²¾ç¡®æ§åˆ¶ Y åæ ‡
                ctx.fillStyle = "#991b1b"; // red-800
                ctx.font = "900 80px monospace"; // æ›´åŠ ç²—
                ctx.fillText(countNum, 0, -stampH / 2 + 90);

                // åº•éƒ¨æ–‡å­—
                ctx.fillStyle = "rgba(185, 28, 28, 0.8)";
                ctx.font = "28px sans-serif";
                ctx.fillText("ä½æ‰¿è¯ºäºº", 0, -stampH / 2 + 180);

                ctx.restore(); // æ¢å¤æ—‹è½¬

                // 6. è½æ¬¾
                const footerY = cardY + cardH - 140;
                ctx.textAlign = "right";
                ctx.fillStyle = "#9ca3af"; // gray-400
                ctx.font = "24px 'Noto Serif SC', serif";
                ctx.fillText("é©¬å…‹æ€ä¸»ä¹‰å­¦é™¢", cardX + cardW - 40, footerY);
                ctx.fillText("å½¢åŠ¿ä¸æ”¿ç­–æ•™ç ”å®¤", cardX + cardW - 40, footerY + 40);
                ctx.font = "24px monospace";
                ctx.fillText("2025.11", cardX + cardW - 40, footerY + 80);

                resolve(canvas.toDataURL('image/png'));
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šç»˜åˆ¶åœ†è§’çŸ©å½¢
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        const fetchParticipantCount = async () => {
            const countEl = document.getElementById('player-count');
            try {
                const response = await fetch('https://h5counter.kai233.top/ljgdh5/counter.php', { cache: 'no-cache' });
                if (!response.ok) throw new Error("Backend unavailable");
                const data = await response.json();
                const count = parseInt(data.count).toLocaleString();
                countEl.innerText = count;
                participantCount = count; // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾› Canvas ä½¿ç”¨
            } catch (error) {
                console.log("Using simulation mode");
                const count = Math.floor(Math.random() * (3000 - 1500) + 1500).toLocaleString();
                countEl.innerText = count;
                participantCount = count;
            }
        };

        window.onload = function () {
            let loaded = 0;
            const total = stages.length;
            const checkLoad = () => {
                loaded++;
                if (loaded >= total) {
                    setTimeout(() => {
                        els.preloader.style.opacity = '0';
                        setTimeout(() => els.preloader.remove(), 500);
                        document.getElementById('header-area').classList.remove('opacity-0');

                        const firstStage = stages[0];
                        els.bgLayer.style.backgroundImage = `url('${firstStage.bg}')`;

                        if (firstStage.isPanorama) {
                            els.bgLayer.classList.add('bg-pan-effect');
                        } else {
                            els.bgLayer.classList.add('bg-cover', 'bg-center', 'bg-zoom-effect');
                        }

                    }, 500);
                }
            };
            stages.forEach(s => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = checkLoad;
                img.onerror = checkLoad;
                img.src = s.bg;
            });
        };

        els.btnDrag.addEventListener('touchstart', startDrag, { passive: false });
        window.addEventListener('touchmove', moveDrag, { passive: false });
        window.addEventListener('touchend', endDrag);

        els.btnDrag.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', moveDrag);
        window.addEventListener('mouseup', endDrag);

    </script>
</body>

</html>